---
title: 数据传输
titleSuffix: Configuration Manager
description: 了解 Configuration Manager 如何在站点之间移动数据，并了解如何管理网络上的数据传输。
ms.date: 07/26/2019
ms.prod: configuration-manager
ms.technology: configmgr-other
ms.topic: conceptual
ms.assetid: dc526e8d-fac3-4bb5-b206-03ad29b0ae11
author: mestew
ms.author: mstewart
manager: dougeby
ms.collection: M365-identity-device-management
ms.openlocfilehash: cf2890f44bcb6e8e7813581de300e4544202f6ce
ms.sourcegitcommit: 72faa1266b31849ce1a23d661a1620b01e94f517
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 07/26/2019
ms.locfileid: "68536242"
---
# <a name="data-transfers-between-sites-in-configuration-manager"></a>Configuration Manager 在站点之间的数据传输

适用范围：  System Center Configuration Manager (Current Branch)

Configuration Manager 使用基于文件的复制  和数据库复制  在站点之间传输不同类型的信息。 了解 Configuration Manager 如何在站点之间移动数据，并了解如何管理网络上的数据传输。  


## <a name="bkmk_fileroute"></a> File-based replication

Configuration Manager 使用基于文件的复制在层次结构中的站点之间传输基于文件的数据。 此数据包括要部署到子站点中的分发点的应用程序和包。 它还包括未处理的发现数据记录，这些记录将传输到父站点然后进行处理。  

站点之间基于文件的通信通过 TCP/IP 端口 445 使用服务器消息块  * (SMB) 协议。 要控制通过网络传输的数据量，请指定带宽限制和脉冲模式。 还可以使用计划来控制何时通过网络发送数据。  

### <a name="bkmk_routes"></a> 文件复制路由

下列信息有助于你设置和使用文件复制路由。  

#### <a name="file-replication-route"></a>文件复制路由

每个文件复制路由都确定可将基于文件的数据传输到其中的目标站点。 每个站点都支持到特定目标站点的单一文件复制路由。  

若要管理文件复制路由，请在“管理”  工作区中展开“层次结构配置”  ，然后选择“文件复制”节点  。  

可以为文件复制路由更改以下设置：  

##### <a name="file-replication-account"></a>文件复制帐户

此帐户连接目标站点，并将数据写入该站点的 **SMS_Site** 共享。 接收站点处理写入到此共享的数据。 默认情况下，将站点添加到层次结构后，Configuration Manager 将新站点服务器的计算机帐户指定为该站点的文件复制帐户。 然后，将此帐户添加到目标站点的 SMS_SiteToSiteConnection_&lt;Sitecode\>  组。 这个组是计算机上的本地组，用于授予对 SMS_Site 共享的访问权限。 你可以将此帐户更改为 Windows 用户帐户。 如果更改帐户，请确保将它添加到目标站点的 SMS_SiteToSiteConnection_&lt;Sitecode\>  组。  

> [!NOTE]  
> 辅助站点始终使用辅助站点服务器的计算机帐户作为“文件复制帐户”  。  

##### <a name="schedule"></a>计划

若要限制可将数据传输到目标站点时的日期和时间的类型，可以为每个文件复制路由设置计划。

##### <a name="rate-limits"></a>速率限制

若要控制站点在将数据传输到目标站点时使用的网络带宽，可以为每个文件复制路由指定速率限制：

- **脉冲模式**：指定由站点发送到目标站点的数据块的大小。 也可以指定发送各个数据块之间的时间延迟。 如果必须在连接目标站点的低带宽网络上发送数据，请使用此选项。

    例如，你有每五秒发送 1 KB 数据（而不是每三秒发送 1 KB）的限制，不考虑某个给定时间的链接速度或其使用率。

- **限制为按小时计算的最大传输速率**：站点仅使用你指定的时间百分比将数据发送到目标站点。 使用此选项时，Configuration Manager 无法识别网络的可用带宽。 相反，它将可发送数据的时间划分为多个部分。 然后在一个短时间段内发送数据，之后的几个时间段则不发送数据。

    例如，将最大速率设置为 50%  。 Configuration Manager 传输数据并持续一段时间后，在相同的时长内不发送任何数据。 它不会管理实际数据量的实际大小或数据块大小。 它只管理发送数据的时间量。  

    > [!CAUTION]  
    > 默认情况下，站点可使用最多三个“并发发送”  来将数据传输到目标站点。 如果为文件复制路由启用速率限制，则针对该站点的“并发发送”  数将限制为 1。 即使“限制可用带宽(%)”  设置为“100%”  ，此行为也适用。 例如，如果为发送程序使用默认设置，则此设置会将传输到目标站点时的速率减少到默认能力的三分之一。  

##### <a name="secondary-sites"></a>辅助站点

你可以在两个辅助站点之间配置文件复制路由，以在这些站点之间传输基于文件的内容。  


#### <a name="sender"></a>发送程序

每个站点均具有一个发送程序。 发送程序管理从一个站点到一个目标站点的网络连接，并且还可以同时与多个站点建立连接。 为连接到站点，发送程序使用指向站点的文件复制路由来标识要用于建立网络连接的帐户。 发送程序还使用此帐户将数据写入目标站点的 SMS_Site 共享。  

默认情况下，发送程序通过使用多个“并发发送”  （通常指线程）将数据写到目标站点。 每个并发发送或线程可以将基于文件的不同对象传输到目标站点。 默认情况下，如果发送程序开始发送对象，则发送程序会持续写入该对象的数据块直到整个对象发送完毕。 在该对象的所有数据均已发送完毕后，即可在该线程上开始发送新的对象。  

若要管理站点的发送程序，请转到“管理”工作区，然后展开“站点配置”节点   。 选择“站点”节点，然后选择要管理的站点的“属性”   。 切换到“发送程序”  选项卡以更改发送程序设置。  

可以为发送程序更改下列设置：  

##### <a name="maximum-concurrent-sendings"></a>最大并发发送数

默认情况下，每个站点都使用五个并发发送。 在向任何一个目标站点发送数据时，可以使用三个线程。 提高此数字时，可增加站点之间的数据吞吐量，因为 Configuration Manager 可同时传输更多文件。 提高此数字还会提高对站点之间的网络带宽的要求。  

##### <a name="retry-settings"></a>重试设置

默认情况下，每个站点对问题连接重试两次，并在连接尝试之间延迟一分钟。 可以修改站点所做的连接尝试数和尝试之间的等待时长。  


## <a name="bkmk_dbrep"></a> Database replication

Configuration Manager 数据库复制使用 SQL Server 传输数据，并将站点数据库中所做的更改与存储在层次结构中其他站点上的数据库中的信息合并在一起。

在层次结构中：

- 所有站点共享相同的信息。  
- 在层次结构中安装站点时，Configuration Manager 将自动在新站点与其父站点之间建立数据库复制。  
- 当站点安装完成后，数据库复制将自动开始。  

向层次结构添加新站点时，Configuration Manager 会在该新站点创建通用数据库。 接下来，父站点将在其数据库中创建相关数据的快照，然后通过基于文件的复制将该快照传输到新站点。 然后，新站点使用 SQL Server 成批复制程序 (BCP) 将信息加载到其 Configuration Manager 数据库的本地副本。 在快照加载后，每个站点均会与其他站点执行数据库复制。  

为在站点之间复制数据，Configuration Manager 会使用其自己的数据库复制服务。 数据库复制服务使用 SQL Server 更改跟踪来监视本地站点数据库的变化。 然后，它使用 SQL Server Service Broker (SSB) 将更改复制到其他站点。 默认情况下，此过程使用 TCP/IP 端口 4022。  

### <a name="replication-groups"></a>复制组

Configuration Manager 将由数据库复制造成的重复数据划分到不同复制组。 每个复制组都有一个单独的固定复制计划。 站点使用此计划来确定将更改复制到其他站点的频率。  

例如，对基于角色的管理配置的更改会快速复制到其他站点。 此行为可确保其他站点可以快速地强制执行这些更改。 优先级较低的配置更改（如请求安装新辅助站点），复制的紧迫性会少些。 新站点请求可能需要几分钟才能达到目标主站点。  

### <a name="settings-for-database-replication"></a>数据库复制的设置

对于数据库复制，可以修改以下设置：  

- **数据库复制链接**：控制特定流量何时遍历网络。  

- **分布式视图**：在管理中心站点 (CAS) 针对选定站点数据发出请求时，它可以从子主站点的数据库中直接访问该数据。  

- **计划**：指定使用复制链接的情形并指定复制不同类型的站点数据的情形。  

- **摘要**：针对遍历复制链接的网络流量的数据摘要设置。 默认情况下，汇总每 15 分钟发生一次。 它用于数据库复制报表。  

- **数据库复制阈值**：定义 Configuration Manager 何时将链接报告为降级或失败。 还可以配置它在何时发出有关复制链接处于降级或失败状态的警报。  

### <a name="types-of-data"></a>数据类型

Configuration Manager 将它复制的数据主要分为全局数据和站点数据两类   。 当发生数据库复制时，站点将跨数据库复制链接来传输全局数据和站点数据的更改。 全局数据复制到父站点或子站点。 站点数据仅复制到父站点。 第三类数据类型（本地数据）  不会复制到其他任何站点。 本地数据是指其他站点不需要的信息。

#### <a name="global-data"></a>全局数据

全局数据是管理员创建的对象，这些对象将复制到整个层次结构中的所有站点。 辅助站点仅接收作为全局代理数据的全局数据的一个子集。 用户在 CAS 和主站点创建全局数据。 此类型包括以下数据：

- 软件部署
- 软件更新
- 集合定义
- 基于角色的管理安全作用域

#### <a name="site-data"></a>站点数据

站点数据是 Configuration Manager 主站点及其分配的客户端创建的操作信息。 站点数据复制到 CAS，但不复制到其他主站点。 站点数据仅在 CAS 和它源自的主站点中可见。 只能修改在创建站点数据的主站点上的站点数据。 此类型包括以下数据：

- 硬件清单
- 状态消息
- 警报
- 基于查询的集合的结果

所有站点数据都复制到 CAS。 CAS 为整个站点层次结构执行管理和报告操作。  

### <a name="bkmk_Dblinks"></a> 数据库复制链接

在层次结构中安装新站点时，Configuration Manager 将自动在父站点和新站点之间创建数据库复制链接。 它创建单个链接来连接两个站点。  

为帮助你控制跨数据库复制链接的数据传输，可更改每个链接的设置。 每个复制链接均支持单独的配置。 每个数据库复制链接都包括以下控件：  

- 停止将所选站点数据从主站点复制到 CAS。 然后，CAS 可以从主站点的数据库中直接访问此数据。  
- 计划将选定站点数据从子主站点传输到 CAS。
- 定义用于确定数据库复制链接处于降级状态或失败状态的设置。
- 指定何时针对失败的复制链接发出警报。
- 指定 Configuration Manager 对使用复制链接的复制流量的相关数据进行汇总的频率。 此数据在报表中使用。

若要配置数据库复制链接，可在 Configuration Manager 控制台的“数据库复制”  节点上打开该链接的“属性”  。 此节点同时出现在“监视”  工作区中和“管理”  工作区中的“层次结构配置”  节点下。 可以从父站点或子站点中编辑复制链接。

> [!TIP]  
> 你可以编辑任一工作区内“数据库复制”  节点中的数据库复制链接。 不过，在使用“监视”  工作区中的“数据复制”  节点时，还可以查看数据库复制的状态。 它还提供对[复制链接分析器](/sccm/core/servers/manage/monitor-hierarchy-and-replication-infrastructure#BKMK_RLA)工具的访问。 使用此工具可帮助调查数据库复制的问题。  

有关如何配置复制链接的详细信息，请参阅[站点数据库复制控件](#BKMK_DBRepControls)。 有关如何监视复制的详细信息，请参阅[如何监视数据库复制链接和复制状态](/sccm/core/servers/manage/monitor-hierarchy-and-replication-infrastructure#BKMK_MonitorRepLinksAndStatuss)。

### <a name="bkmk_distviews"></a> 分布式视图

通过分布式视图，当你在 CAS 上针对所选站点数据发出请求时，它会直接访问子主站点上的数据库。 直接访问无需再从主站点将该站点数据复制到 CAS。 由于每个复制链接均与其他复制链接无关，因此可仅在所选的复制链接上启用分布式视图。 不能在主站点和辅助站点之间使用分布式视图。  

分布式视图提供以下好处：  

- 降低 CPU 负载以在 CAS 和主站点上处理数据库更改
- 降低跨网络传输到 CAS 的数据量
- 改善托管 CAS 数据库的 SQL Server 性能
- 减少 CAS 数据库使用的磁盘空间

当主站点在网络上临近 CAS 且两个站点始终启动并始终相连时，考虑使用分布式视图。 分布式视图会将站点间选定数据的复制替换为每个站点上 SQL Server 之间的直接连接。 每次请求此数据时，CAS 都会建立直接连接。

在以下示例场景中，站点请求分布式视图数据：

- 运行报表或查询时
- 在资源浏览器中查看信息时
- 对包含基于站点数据的规则的集合进行集合评估时

默认情况下，每个复制链接均已关闭分布式视图。 启用分布式视图时，选择不会跨该链接复制到 CAS 的站点数据。 CAS 会从共享该链接的子主站点数据库直接访问此数据。 你可以为分布式视图配置以下类型的站点数据：  

- 来自客户端的硬件清单数据 
- 来自客户端的软件清单和软件计数数据 
- 来自客户端、主站点和所有辅助站点的状态消息 

在 Configuration Manager 控制台或报表中查看数据时，从操作方面来说，分布式视图对于你不可见。 当你请求针对分布式视图启用的数据时，CAS 站点数据库服务器会直接访问子主站点的数据库以检索信息。

例如，在 CAS 上使用 Configuration Manager 控制台从主站点 ABC 和主大小 XYZ 请求硬件清单信息。 为站点 ABC 上的分布式视图启用硬件清单。 站点从 CAS 数据库检索 XYZ 客户端清单信息。 它从 ABC 站点数据库检索 ABC 客户端清单信息。 此信息将出现在 Configuration Manager 控制台或报表中，但不标识信息源。  

只要复制链接具有一类已对分布式视图启用的数据，子主站点就不会将该数据复制到 CAS。 关闭某类数据的分布式视图后，子主站点会立即恢复将该数据复制到 CAS，并将其作为普通数据复制的一部分。 必须先在主站点和 CAS 之间将包含此数据的复制组重新初始化，CAS 上才会提供此数据。 同样，在卸载已启用分布式视图的主站点后，以及在可以访问 CAS 上的此数据之前，必须先完成其数据的重新初始化。  

> [!IMPORTANT]  
> 在站点层次结构中的任何复制链接上使用分布式视图时，在卸载任何主站点之前，先关闭所有复制链接的分布式视图。 有关详细信息，请参阅 [卸载配置为具有分布式视图的主站点](/sccm/core/servers/deploy/install/uninstall-sites-and-hierarchies#BKMK_UninstallPrimaryDistViews)。  

#### <a name="prerequisites-and-limitations-for-distributed-views"></a>分布式视图的先决条件和限制  

- 只能在 CAS 和主站点之间的复制链接上使用分布式视图。

- CAS 必须使用 SQL Server 企业  版。 主站点没有此要求。

- CAS 只能安装 SMS 提供程序的一个实例。 在站点数据库服务器上安装一个实例。 此要求支持 Kerberos 身份验证。 CAS 上的 SQL Server 要求使用 Kerberos 访问子主站点的 SQL Server。 对于子主站点上的 SMS 提供程序没有任何限制。

- CAS 只能有 SQL Server Reporting Services 的一个实例。 在站点数据库服务器上安装 Reporting Services 点。 此要求支持 Kerberos 身份验证。 CAS 上的 SQL Server 要求使用 Kerberos 访问子主站点的 SQL Server。

- 无法在 [SQL Server 群集](/sccm/core/servers/deploy/configure/use-a-sql-server-cluster-for-the-site-database)上托管站点数据库。

- 在版本 1902 及更早版本中，无法在 [SQL Server Always On 可用性组](/sccm/core/servers/deploy/configure/sql-server-alwayson-for-a-highly-available-site-database)上托管站点数据库。 若要支持此配置，请更新到版本 1906 或更高版本。<!-- SCCMDocs-pr#3792 -->

- CAS 数据库服务器的计算机帐户需要对主站点数据库具有读取权限  。

> [!IMPORTANT]  
> 对于数据库复制链接而言，分布式视图和数据复制[时间计划](#BKMK_schedules)是相互排斥的设置。  

### <a name="BKMK_schedules"></a> 针对数据库复制链接上站点数据的计划传输

为了帮助你控制将站点数据从子主站点复制到其 CAS 时所用的网络带宽，请计划使用复制链接的时间。 还可以指定复制不同类型的站点数据的时间。 你可以控制主站点复制状态消息、清单和计数数据的时间。 辅助站点中的数据库复制链接不支持站点数据计划。 无法计划全局数据传输。  

配置数据库复制链接计划时，可以限制所选站点数据从主站点到 CAS 的传输。 还可以配置不同的时间来复制不同类型的站点数据。  

> [!IMPORTANT]  
> 对于数据库复制链接而言，[分布式视图](#bkmk_distviews)和数据复制时间计划是相互排斥的配置。  

### <a name="BKMK_SummarizeDBReplication"></a> 数据库复制流量汇总

每个站点会定期汇总关于遍历站点数据库复制链接的网络流量的数据。 站点将汇总数据用于数据库复制报表。 复制链接上的两个站点都汇总遍历复制链接的网络流量 站点数据库服务器汇总数据。 汇总数据后，此信息会作为全局数据复制到其他站点。  

默认情况下，汇总每 15 分钟发生一次。 若要修改网络流量汇总的频率，可在数据库复制链接属性中编辑“摘要间隔”  。 汇总频率会影响你在报表中查看的关于数据库复制的信息。 可以选择 5 到 60 分钟的间隔。 如果增加汇总频率，会增加复制链接上每个站点中 SQL Server 的处理负荷。  

### <a name="BKMK_DBRepThresholds"></a>数据库复制阈值

数据库复制阈值定义站点将数据库复制链接状态报告为降级或失败的时间。 默认情况下，如果任何一个复制组在 12 次连续尝试后无法完成复制，则将链接设置为降级状态  。 如果任何一个复制组在 24 次连续尝试期间无法完成复制，则将链接设置为失败状态  。  

可以为降级或失败状态指定自定义值。 如果调整这些值，可以更准确地监视跨链接进行的数据库复制的运行状况。  

一个或多个复制组可能无法复制，而其他复制组可以继续成功复制。 计划在首次报告降级状态时查看链接的复制状态。 如果特定复制组定期出现延迟，并且其延迟未显示问题，或者如果站点之间的网络链接具有低可用带宽，请考虑修改链接的降级或失败状态的值并重试这些值。 如果在将链接设置为降级或失败之前增加重试次数，则可以消除已知问题的假警告，这样，你就可以更加准确地跟踪链接的状态。  

还应该考虑每个复制组的同步间隔，了解该组复制发生的频率。 若要查看复制组的“同步间隔”  ，请在“监视”  工作区的“数据库复制”  节点上，选择复制链接的“复制详细信息”  选项卡。  

有关如何监视数据库复制（包括如何查看复制状态）的详细信息，请参阅[如何监视数据库复制链接和复制状态](/sccm/core/servers/manage/monitor-hierarchy-and-replication-infrastructure#BKMK_MonitorRepLinksAndStatuss)。  

有关配置数据库复制阈值的详细信息，请参阅[站点数据库复制控件](#BKMK_DBRepControls)。  


## <a name="BKMK_DBRepControls"></a> 站点数据库复制控件

可更改每个站点数据库的设置，帮助你控制用于数据库复制的网络带宽。 这些设置仅适用于在其中配置设置的站点数据库。 站点通过数据库将任何数据复制到任何其他站点时，会始终使用这些设置。  

可以为每个站点数据库修改以下复制控件：  

- SSB 端口
- 在复制失败触发站点重新初始化其站点数据库副本之前等待的时间段
- 对通过数据库复制所复制的数据进行压缩。 只会为站点之间的传输压缩数据，而不会为任一站点上站点数据库中的存储压缩数据。  

若要更改站点数据库复制控件的设置，请在 Configuration Manager 控制台中的“数据库复制”  节点上，编辑该站点数据库的属性。 此节点出现在“管理”  工作区中的“层次结构配置”  节点下面，也出现在“监视工作区”  中。 若要编辑站点数据库的属性，请选择站点之间的复制链接，然后打开“父数据库属性”  或“子数据库属性”  。  

> [!TIP]  
> 你可以配置任一工作区内“数据库复制”  节点中的数据库复制控件。 不过，在使用“监视”  工作区中的“数据复制”  节点时，还可以查看数据库复制的状态。 它还提供对[复制链接分析器](/sccm/core/servers/manage/monitor-hierarchy-and-replication-infrastructure#BKMK_RLA)工具的访问。 使用此工具可帮助调查数据库复制的问题。  
